{% extends "forum/base.html" %}
{% load static %}
{% load static dict_extras %}
{% load markdown_extras %}
{% block content %}
    <div class="row justify-content-center">
        <div class="col-lg-9">
            <!-- THREAD CARD -->
            <div class="card mb-4 shadow-sm {% if thread.is_locked %}border-warning bg-warning bg-opacity-10{% endif %}">
                <div class="card-body">
                    <div class="d-flex gap-3">
                        <!-- Thread Author Profile Pic -->
                        <div class="mt-1">
                            {% if thread.author and thread.author.socialaccount_set.first.extra_data.picture %}
                                <img src="{{ thread.author.socialaccount_set.first.extra_data.picture }}"
                                     class="rounded-circle border border-secondary"
                                     width="48"
                                     height="48"
                                     referrerpolicy="no-referrer"
                                     alt="Profile">
                            {% else %}
                                <img src="{% static 'forum/default_user.jpg' %}"
                                     class="rounded-circle border border-secondary"
                                     width="48"
                                     height="48"
                                     alt="Profile">
                            {% endif %}
                        </div>
                        <!-- Thread Content -->
                        <div class="flex-grow-1">
                            <!-- TITLE + LOCK BADGE + ACTIONS -->
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="d-flex align-items-center gap-2">
                                    <h4 class="card-title mb-1">{{ thread.title }}</h4>
                                    {% if thread.is_locked %}<span class="badge bg-warning text-dark">üîí Locked</span>{% endif %}
                                </div>
                                {% if user.is_authenticated %}
                                    <div class="d-flex gap-2">
                                        {% if perms.forum.lock_thread %}
                                            <form method="post"
                                                  action="{% url 'toggle-thread-lock' thread.id %}"
                                                  class="d-inline">
                                                {% csrf_token %}
                                                {% if thread.is_locked %}
                                                    <button type="submit" class="btn btn-sm btn-outline-success">Unlock</button>
                                                {% else %}
                                                    <button type="submit" class="btn btn-sm btn-outline-warning">Lock</button>
                                                {% endif %}
                                            </form>
                                        {% endif %}
                                        <!-- REPORT THREAD (GET) -->
                                        <a href="{% url 'report-thread' thread.id %}"
                                           class="btn btn-sm btn-outline-secondary">üö© Report</a>
                                        {% if perms.forum.delete_any_thread %}
                                            <form method="post"
                                                  action="{% url 'delete-thread' thread.id %}"
                                                  class="d-inline">
                                                {% csrf_token %}
                                                <button type="submit"
                                                        class="btn btn-sm btn-outline-danger"
                                                        onclick="return confirm('Are you sure you want to delete this thread?');">
                                                    Delete
                                                </button>
                                            </form>
                                        {% elif thread.author == user and not thread.is_locked %}
                                            <form method="post"
                                                  action="{% url 'delete-thread' thread.id %}"
                                                  class="d-inline">
                                                {% csrf_token %}
                                                <button type="submit"
                                                        class="btn btn-sm btn-outline-danger"
                                                        onclick="return confirm('Are you sure you want to delete this thread?');">
                                                    Delete
                                                </button>
                                            </form>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="text-muted small mb-2">
                                Posted by
                                {% if thread.author %}
                                    {{ thread.author.get_full_name }}
                                {% else %}
                                    <em>Deleted user</em>
                                {% endif %}
                                ¬∑ {{ thread.created_timestamp|timesince }} ago
                            </div>
                            <div class="mb-2">
                                <span class="badge bg-primary me-1">{{ thread.category.name }}</span>
                                {% if thread.course %}
                                    <span class="badge bg-success">{{ thread.course.code }}: {{ thread.course.title }}</span>
                                {% endif %}
                            </div>
                            <p class="card-text mt-3">{{ thread.content|markdownify|safe }}</p>
                            {% if thread.tags.all %}
                                <div class="mb-3">
                                    {% for tag in thread.tags.all %}<span class="badge bg-secondary me-1">#{{ tag.name }}</span>{% endfor %}
                                </div>
                            {% endif %}
                            {% if thread.resource %}
                                <div class="alert alert-light border d-flex justify-content-between align-items-center mt-3">
                                    <div>
                                        <strong>Attached Resource:</strong>
                                        {{ thread.resource.title }}
                                    </div>
                                    <a href="{{ thread.resource.link }}"
                                       target="_blank"
                                       class="btn btn-sm btn-outline-primary">Open</a>
                                </div>
                            {% endif %}
                            <div class="mt-3 d-flex align-items-center gap-2">
                                <button class="btn btn-sm btn-outline-primary thread-like-btn"
                                        data-thread-id="{{ thread.id }}">
                                    üëç <span class="thread-like-text">Like</span>
                                </button>
                                <span class="text-muted small">
                                    <span id="thread-like-count">0</span> upvotes
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- INLINE REPLY TO THREAD -->
            {% if user.is_authenticated and not thread.is_locked %}
                <div class="card mb-4 shadow-sm">
                    <div class="card-body">
                        <h6 class="fw-semibold mb-2">Write a reply</h6>
                        <form method="post"
                              action="{% url 'reply-thread' thread.category.slug thread.id %}">
                            {% csrf_token %}
                            {{ reply_form.content }}
                            <div class="text-end mt-2">
                                <button type="submit" class="btn btn-primary btn-sm">Reply</button>
                            </div>
                        </form>
                    </div>
                </div>
            {% elif thread.is_locked %}
                <div class="alert alert-warning mb-4">This thread is locked. No replies or quotes are allowed.</div>
            {% endif %}
            <!-- REPLIES -->
            <h5 class="mb-3">Replies</h5>
            {% for reply in page_obj %}
                <div class="card mb-2" id="reply-{{ reply.id }}">
                    <div class="card-body">
                        <div class="d-flex gap-3">
                            <!-- Reply Author Profile Pic -->
                            <div class="mt-1">
                                {% if reply.author and reply.author.socialaccount_set.first.extra_data.picture %}
                                    <img src="{{ reply.author.socialaccount_set.first.extra_data.picture }}"
                                         class="rounded-circle border border-secondary"
                                         width="40"
                                         height="40"
                                         referrerpolicy="no-referrer"
                                         alt="Profile">
                                {% else %}
                                    <img src="{% static 'forum/default_user.jpg' %}"
                                         class="rounded-circle border border-secondary"
                                         width="40"
                                         height="40"
                                         alt="Profile">
                                {% endif %}
                            </div>
                            <!-- Reply Content -->
                            <div class="flex-grow-1">
                                <div class="text-muted small mb-1">
                                    {% if reply.author %}
                                        {{ reply.author.get_full_name|default:reply.author.email }}
                                    {% else %}
                                        <em>Deleted user</em>
                                    {% endif %}
                                    ¬∑ {{ reply.created_timestamp|timesince }} ago
                                </div>
                                {% if reply.parent %}
                                    <div class="border-start border-3 ps-3 mb-2 text-muted fst-italic">
                                        <strong>
                                            <a href="?page={{ reply_page_map|get_item:reply.parent.id }}#reply-{{ reply.parent.id }}"
                                               class="text-decoration-none text-muted fw-semibold">
                                                {{ reply.parent.author.get_full_name|default:"User" }}
                                            </a>
                                            said:
                                        </strong>
                                        <br>
                                        {{ reply.parent.content|truncatewords:40 }}
                                    </div>
                                {% endif %}
                                <p class="mb-2">{{ reply.content }}</p>
                                <div class="mt-2 d-flex align-items-center gap-2">
                                    <button class="btn btn-sm btn-outline-secondary reply-like-btn"
                                            data-reply-id="{{ reply.id }}">
                                        üëç <span class="reply-like-text">Like</span>
                                    </button>
                                    <span class="text-muted small">
                                        <span id="reply-like-count-{{ reply.id }}">0</span>
                                    </span>
                                </div>
                                {% if user.is_authenticated %}
                                    <div class="d-flex gap-3 align-items-center">
                                        {% if not thread.is_locked %}
                                            <a class="text-primary small"
                                               data-bs-toggle="collapse"
                                               href="#reply-form-{{ reply.id }}">Quote</a>
                                        {% endif %}
                                        <!-- REPORT REPLY (GET) -->
                                        <a href="{% url 'report-reply' reply.id %}"
                                           class="btn btn-link p-0 text-secondary small text-decoration-none">
                                            üö© Report
                                        </a>
                                        {% if perms.forum.delete_any_reply %}
                                            <form method="post"
                                                  action="{% url 'delete-reply' reply.id %}"
                                                  class="d-inline">
                                                {% csrf_token %}
                                                <button type="submit"
                                                        class="btn btn-link p-0 text-danger small"
                                                        onclick="return confirm('Are you sure you want to delete this reply?');">
                                                    Delete
                                                </button>
                                            </form>
                                        {% elif reply.author == user and not thread.is_locked %}
                                            <form method="post"
                                                  action="{% url 'delete-reply' reply.id %}"
                                                  class="d-inline">
                                                {% csrf_token %}
                                                <button type="submit"
                                                        class="btn btn-link p-0 text-danger small"
                                                        onclick="return confirm('Are you sure you want to delete this reply?');">
                                                    Delete
                                                </button>
                                            </form>
                                        {% endif %}
                                    </div>
                                    {% if not thread.is_locked %}
                                        <div class="collapse mt-2" id="reply-form-{{ reply.id }}">
                                            <form method="post"
                                                  action="{% url 'reply-reply' thread.category.slug thread.id reply.id %}">
                                                {% csrf_token %}
                                                {{ reply_form.content }}
                                                <div class="d-flex gap-2 mt-2">
                                                    <button type="submit" class="btn btn-sm btn-outline-primary">Reply</button>
                                                    <button type="button"
                                                            class="btn btn-sm btn-outline-secondary"
                                                            data-bs-toggle="collapse"
                                                            data-bs-target="#reply-form-{{ reply.id }}">Cancel</button>
                                                </div>
                                            </form>
                                        </div>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="alert alert-info">No replies yet.</div>
            {% endfor %}
            <!-- PAGINATION -->
            {% if page_obj.paginator.num_pages > 1 %}
                <nav class="mt-4">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">Previous</span>
                            </li>
                        {% endif %}
                        {% for num in page_obj.paginator.page_range %}
                            {% if num == page_obj.number %}
                                <li class="page-item active">
                                    <span class="page-link">{{ num }}</span>
                                </li>
                            {% else %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}
                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">Next</span>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            {% endif %}
        </div>
    </div>
    <script>
  document.addEventListener("DOMContentLoaded", () => {

    // ---------------- THREAD LIKE ----------------
    const threadBtn = document.querySelector(".thread-like-btn");
    const threadCount = document.getElementById("thread-like-count");

    if (threadBtn) {
      const threadId = threadBtn.dataset.threadId;

      // GET initial state
      fetch(`/thread/${threadId}/like/`)
        .then(res => res.json())
        .then(data => {
          threadCount.innerText = data.upvote_count;
          threadBtn.querySelector(".thread-like-text").innerText =
            data.liked ? "Unlike" : "Like";
        });

      // POST toggle
      threadBtn.addEventListener("click", () => {
        fetch(`/thread/${threadId}/like/`, {
          method: "POST",
          headers: {
            "X-CSRFToken": "{{ csrf_token }}",
          },
        })
          .then(res => res.json())
          .then(data => {
            threadCount.innerText = data.upvote_count;
            threadBtn.querySelector(".thread-like-text").innerText =
              data.liked ? "Unlike" : "Like";
          });
      });
    }

    // ---------------- REPLY LIKE ----------------
    document.querySelectorAll(".reply-like-btn").forEach(btn => {
      const replyId = btn.dataset.replyId;
      const countSpan = document.getElementById(`reply-like-count-${replyId}`);
      const textSpan = btn.querySelector(".reply-like-text");

      // GET initial state
      fetch(`/reply/${replyId}/like/`)
        .then(res => res.json())
        .then(data => {
          countSpan.innerText = data.upvote_count;
          textSpan.innerText = data.liked ? "Unlike" : "Like";
        });

      // POST toggle
      btn.addEventListener("click", () => {
        fetch(`/reply/${replyId}/like/`, {
          method: "POST",
          headers: {
            "X-CSRFToken": "{{ csrf_token }}",
          },
        })
          .then(res => res.json())
          .then(data => {
            countSpan.innerText = data.upvote_count;
            textSpan.innerText = data.liked ? "Unlike" : "Like";
          });
      });
    });

  });
    </script>
{% endblock content %}
